# Sorald support scripts
This directory contains a Python package with support scripts for Sorald.

## Requirements
Python 3.8+ and Git 2.x. Some scripts also require Sorald to be available from
the command line, which in that case is detailed in the individual script's
description.

## Install
Assuming that you are currently in this directory, install the support scripts
package like so.

```bash
$ python3 -m pip install .
```

It is however strongly recommended that you install the scripts inside of a
[virtual environment (link to a good article about it)](https://realpython.com/effective-python-environment/#virtual-environments),
to avoid polluting your system-wide or user packages. One way to do that is
to use the `venv` module, which normally ships with Python.

```bash
$ python3 -m venv env # creates a virtual environment in directory "env"
$ source env/bin/activate # activates the virtual environment
[ ... work on your stuff ... ]
$ deactivate # exits the virtual environment
```

Once the virtual environment is active, any package installed with `pip
install` will end up in the local `env` directory.

> **Note:** On some Linux distributions, such as Debian-based ones, `venv` is
> not always shipped with `python3`, and you may need to install a separate
> `python3-venv` or `python3-dev` system package.

For development, add the `-e` flag to make an editable install.

```bash
$ python3 -m pip install -e .
```

An editable install lets any changes you make to your source code be visible in
the installed package immediately, whereas a normal install requires you to
reinstall the package for each change.

## Uninstall

```bash
$ python3 -m pip uninstall soraldscripts
```

## Running tests
To run the tests for the helper scripts, first install the test dependencies.

```bash
$ python3 -m pip install -e .[TEST]
```

Then execute `pytest`.

```bash
$ python3 -m pytest tests/
```

## Adding a new script
Simply put a Python script into the `sorald` directory. That makes it part of
the `sorald` package. Assuming that the script is called `script.py`, you can
run the script (after installing the support scripts package according to the
instructions in this README) like so:

```bash
$ python3 -m sorald.script
```

To test the script, you can add a new file in the `tests` directory, called
`tests/test_script.py`. Those tests can be executed as described in [Running
tests](#running-tests).

> **Important:** Don't forget to add a description of the new script in the
> [Scripts](#scripts) section.

## Scripts
This section details usage of the scripts in the support package.

### `sorald.achievements`
The achievements script can be used to generate an "achievements" file for
Sorald, detailing the pull requests performed with it. It's essentially a
human-readable version of the PRs JSON file.

The script is only usable in a single way: given a `prs.json` file, it
generates a human-readable Markdown file with some of the interesting content.
Use like so:

```bash
$ python3 -m sorald.achievements --prs-json-file path/to/prs.json --output ACHIEVEMENTS.md
```

### `sorald.prmessage`
The PR message script can be used to easily generate a PR message with
information about the repairs that have been made. The current version
is tailored for repair of a single rule, as that's what we have been
targeting with our PRs thus far. It could fairly easily be extended
to encompass multi-rule repairs, for example by parsing the JSON stats
output from Sorald.

The script currently just prints the message to standard output, with the first
line being the title (make sure to remove the `PULL REQUEST TITLE: ` prefix).

Usage is currently like so:

```
$ python3 -m sorald.prmessage --rule-key <RULE_KEY> --num-repairs <NUM_REPAIRS>
```

For example, generating a PR message for a patch in which Sorald has repaired 2
violations of Sonar Rule 2111, one would call the script like so.

```
$ python3 -m sorald.prmessage --rule-key 2111 --num-repairs 2
```

This generates a PR message with some appropriate text and links to both
Sorald's and Sonar's documentation for the given rule.

### `sorald.prrecorder`
The PR recorder script can be used to collect data from pull requests made with
sorald. It is the JSON file generated by this script that's used by
`sorald.achievements`.

One can run the PR recorder by executing the `sorald.prrecorder` script with Python.

```bash
$ python3 -m sorald.prrecorder [options]
```

To show the available commands, run with the `--help` flag.

```
$ python3 sorald.prrecorder --help
usage: sorald.prrecorder [-h] {record-initial,record-final,add-manual-edit} ...

positional arguments:
  {record-initial,record-final,add-manual-edit}
    record-initial      make the initial record for a PR
    record-final        make the final record for a PR
    add-manual-edit     add a diff representing a manual edit of a PR

optional arguments:
  -h, --help            show this help message and exit
```

In general, one must always make an initial and final record using the
`record-initial` and `record-final` commands. Running `add-manual-edit` is
optional and allows one to record manual edits performed on the PR, i.e. edits
that were not made with Sorald itself.

The rest of this section contains an example use case of recording the PR
[redhat-developer/rsp-server#619](https://github.com/redhat-developer/rsp-server/pulls/619).

#### Step 1: Make the initial record (`record-initial`)
When the PR has been opened, one should make the initial record. It can be done like so.

```bash
$ python3 -m sorald.prrecorder record-initial \
    --owner redhat-developer \
    --repo-name rsp-server \
    --pr-number 619 \
    --sorald-stats-file stats.json
```

Note that `stats.json` is the statistics file generated by Sorald when running
with statistics collection.

The command executed above creates a file `prs.json` with an initial record
like this:

```json
{
    "redhat-developer/rsp-server#619": {
        "repoSlug": "redhat-developer/rsp-server",
        "prMetadata": {
            "url": "https://github.com/redhat-developer/rsp-server/pull/619",
            "createdAt": "2020-11-25 12:01:06",
            "closedAt": null,
            "mergedAt": null",
            "state": "open",
            "isMerged": false,
            "number": 619
        },
        "soraldStatistics": {
            "repairs": [
                {
                    "nbPerformedRepairs": 4,
                    "ruleName": "XxeProcessing",
                    "crashedRepairsLocations": [],
                    "nbCrashedRepairs": 0,
                    "ruleKey": "2755",
                    "nbViolationsBefore": 4,
                    "performedRepairsLocations": [
                        {
                            "endLine": 85,
                            "endColumn": 52,
                            "startColumn": 41,
                            "startLine": 85,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java:85:41:85:52"
                        },
                        {
                            "endLine": 92,
                            "endColumn": 70,
                            "startColumn": 59,
                            "startLine": 92,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:92:59:92:70"
                        },
                        {
                            "endLine": 129,
                            "endColumn": 48,
                            "startColumn": 37,
                            "startLine": 129,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:129:37:129:48"
                        },
                        {
                            "endLine": 351,
                            "endColumn": 62,
                            "startColumn": 51,
                            "startLine": 351,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:351:51:351:62"
                        }
                    ],
                    "nbViolationsAfter": 0
                }
            ],
            "executionInfo": {
                "soraldVersion": "commit: 33c4d13b",
                "javaVersion": "11.0.8",
                "originalArgs": [
                    "repair",
                    "--rule-keys",
                    "2755",
                    "--file-output-strategy",
                    "IN_PLACE",
                    "--original-files-path",
                    ".",
                    "--stats-output-file",
                    "stats.json"
                ]
            },
            "totalTimeMs": 11659,
            "repairTimeMs": 315,
            "startTimeMs": 1608221551366,
            "crashes": [],
            "endTimeMs": 1608221563025,
            "parseTimeMs": 2886
        },
        "diffs": {
            "initial": "diff --git a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\nindex 26e318d6..e8f3d908 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n@@ -7,6 +7,7 @@\n  * Contributors: Red Hat, Inc.\n  ******************************************************************************/\n package org.jboss.tools.rsp.internal.launching.java.util;\n+import javax.xml.XMLConstants;\n \n import java.io.ByteArrayInputStream;\n import java.io.File;\n@@ -82,7 +83,7 @@\n \tprivate static DocumentBuilder getParser() throws CoreException {\n \t\tif (fgXMLParser == null) {\n \t\t\ttry {\n-\t\t\t\tfgXMLParser = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+\t\t\t\tfgXMLParser = createDocumentBuilderFactory().newDocumentBuilder();\n \t\t\t\tfgXMLParser.setErrorHandler(new DefaultHandler());\n \t\t\t} catch (ParserConfigurationException e) {\n \t\t\t\tabort(LaunchingPlugin_34, e);\n@@ -348,4 +349,11 @@ protected static void abort(String message, Throwable exception, int code) throw\n \t\tthrow new CoreException(new Status(IStatus.ERROR, IVMInstallChangedListener.LAUNCHING_ID_PLUGIN,\n \t\t\t\tcode, message, exception));\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n }\ndiff --git a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\nindex 291d3814..92e60d19 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n@@ -89,7 +89,7 @@ public static XMLMemento createReadRoot(InputStream in) {\n \t\t\n \t\tDocument document = null;\n \t\ttry {\t\n-\t\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\t\tDocumentBuilderFactory factory = createDocumentBuilderFactory();\n \t\t\tDocumentBuilder parser = factory.newDocumentBuilder();\n \t\t\tdocument = parser.parse(new InputSource(in));\n \t\t\tNode node = document.getFirstChild();\n@@ -126,7 +126,7 @@ private static void logError(Exception t) {\n \tpublic static XMLMemento createWriteRoot(String type) {\n \t\tDocument document;\n \t\ttry {\n-\t\t\tdocument = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();\n+\t\t\tdocument = createDocumentBuilderFactory().newDocumentBuilder().newDocument();\n \t\t\tElement element = document.createElement(type);\n \t\t\tdocument.appendChild(element);\n \t\t\treturn new XMLMemento(document, element);\n@@ -348,7 +348,7 @@ public void save(OutputStream os) throws IOException {\n \t\tResult result = new StreamResult(os);\n \t\tSource source = new DOMSource(factory);\n \t\ttry {\n-\t\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\t\tTransformerFactory factory = createTransformerFactory();\n \t\t\tfactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n \t\t\tTransformer transformer = factory.newTransformer();\n \t\t\ttransformer.setOutputProperty(OutputKeys.INDENT, \"yes\"); //$NON-NLS-1$\n@@ -436,4 +436,18 @@ public String getTextData() {\n \t\t}\n \t\treturn \"\"; //$NON-NLS-1$\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n+\n+\tprivate static TransformerFactory createTransformerFactory() {\n+\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, \"\");\n+\t\treturn factory;\n+\t}\n }\n\\ No newline at end of file\n",
            "final": null
        },
        "manualEdits": [],
        "recordMetadata": {
            "createdAt": "2020-12-17 17:19:56.195013",
            "lastModified": "2020-12-17 17:19:56.195013"
        }
    }
}
```

#### Step 2: Update the record after PR has been accepted/rejected (`record-final`)

This step really only updates the PR metadata (`closedAt`, `isMerged` etc),
and inserts the `diffs.final` value. Can be executed like so:

```bash
$ python3 -m sorald.prrecorder record-final \
    --owner redhat-developer \
    --repo-name rsp-server \
    --pr-number 619
```

So it's just like `record-initial`, except that it doesn't take the
`--sorald-stats-file` input.

#### Step 3 (optional): Record manual edits (`add-manual-edit`)

If we make manual edits to a PR, we need to make note of this. For example, if
we make an edit after the PR has been opened, we can record it like so:

```bash
$ python3 -m sorald.prrecorder add-manual-edit \
    --owner redhat-developer \
    --repo-name rsp-server \
    --pr-number 619 \
    --diff-file diff.txt \
    --edit-type after_open_pr \
    --edit-reason "this can be whatever"
```

This shows up like so in the record:

```json
        "manual_edits": [
            {
                "type": "afterOpenPr",
                "reason": "this can be whatever",
                "diff": "I didn't actually do any manual edits :)\n"
            }
        ],
```

#### Final result

After these three command shave been executed, my `prs.json` looks like this:

```json
{
    "redhat-developer/rsp-server#619": {
        "repoSlug": "redhat-developer/rsp-server",
        "prMetadata": {
            "url": "https://github.com/redhat-developer/rsp-server/pull/619",
            "createdAt": "2020-11-25 12:01:06",
            "closedAt": "2020-11-30 20:45:38",
            "mergedAt": "2020-11-30 20:45:38",
            "state": "closed",
            "isMerged": true,
            "number": 619
        },
        "soraldStatistics": {
            "repairs": [
                {
                    "nbPerformedRepairs": 4,
                    "ruleName": "XxeProcessing",
                    "crashedRepairsLocations": [],
                    "nbCrashedRepairs": 0,
                    "ruleKey": "2755",
                    "nbViolationsBefore": 4,
                    "performedRepairsLocations": [
                        {
                            "endLine": 85,
                            "endColumn": 52,
                            "startColumn": 41,
                            "startLine": 85,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java:85:41:85:52"
                        },
                        {
                            "endLine": 92,
                            "endColumn": 70,
                            "startColumn": 59,
                            "startLine": 92,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:92:59:92:70"
                        },
                        {
                            "endLine": 129,
                            "endColumn": 48,
                            "startColumn": 37,
                            "startLine": 129,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:129:37:129:48"
                        },
                        {
                            "endLine": 351,
                            "endColumn": 62,
                            "startColumn": 51,
                            "startLine": 351,
                            "filePath": "framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java",
                            "violationSpecifier": "2755:framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java:351:51:351:62"
                        }
                    ],
                    "nbViolationsAfter": 0
                }
            ],
            "executionInfo": {
                "soraldVersion": "commit: 33c4d13b",
                "javaVersion": "11.0.8",
                "originalArgs": [
                    "repair",
                    "--rule-keys",
                    "2755",
                    "--file-output-strategy",
                    "IN_PLACE",
                    "--original-files-path",
                    ".",
                    "--stats-output-file",
                    "stats.json"
                ]
            },
            "totalTimeMs": 11659,
            "repairTimeMs": 315,
            "startTimeMs": 1608221551366,
            "crashes": [],
            "endTimeMs": 1608221563025,
            "parseTimeMs": 2886
        },
        "diffs": {
            "initial": "diff --git a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\nindex 26e318d6..e8f3d908 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n@@ -7,6 +7,7 @@\n  * Contributors: Red Hat, Inc.\n  ******************************************************************************/\n package org.jboss.tools.rsp.internal.launching.java.util;\n+import javax.xml.XMLConstants;\n \n import java.io.ByteArrayInputStream;\n import java.io.File;\n@@ -82,7 +83,7 @@\n \tprivate static DocumentBuilder getParser() throws CoreException {\n \t\tif (fgXMLParser == null) {\n \t\t\ttry {\n-\t\t\t\tfgXMLParser = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+\t\t\t\tfgXMLParser = createDocumentBuilderFactory().newDocumentBuilder();\n \t\t\t\tfgXMLParser.setErrorHandler(new DefaultHandler());\n \t\t\t} catch (ParserConfigurationException e) {\n \t\t\t\tabort(LaunchingPlugin_34, e);\n@@ -348,4 +349,11 @@ protected static void abort(String message, Throwable exception, int code) throw\n \t\tthrow new CoreException(new Status(IStatus.ERROR, IVMInstallChangedListener.LAUNCHING_ID_PLUGIN,\n \t\t\t\tcode, message, exception));\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n }\ndiff --git a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\nindex 291d3814..92e60d19 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n@@ -89,7 +89,7 @@ public static XMLMemento createReadRoot(InputStream in) {\n \t\t\n \t\tDocument document = null;\n \t\ttry {\t\n-\t\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\t\tDocumentBuilderFactory factory = createDocumentBuilderFactory();\n \t\t\tDocumentBuilder parser = factory.newDocumentBuilder();\n \t\t\tdocument = parser.parse(new InputSource(in));\n \t\t\tNode node = document.getFirstChild();\n@@ -126,7 +126,7 @@ private static void logError(Exception t) {\n \tpublic static XMLMemento createWriteRoot(String type) {\n \t\tDocument document;\n \t\ttry {\n-\t\t\tdocument = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();\n+\t\t\tdocument = createDocumentBuilderFactory().newDocumentBuilder().newDocument();\n \t\t\tElement element = document.createElement(type);\n \t\t\tdocument.appendChild(element);\n \t\t\treturn new XMLMemento(document, element);\n@@ -348,7 +348,7 @@ public void save(OutputStream os) throws IOException {\n \t\tResult result = new StreamResult(os);\n \t\tSource source = new DOMSource(factory);\n \t\ttry {\n-\t\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\t\tTransformerFactory factory = createTransformerFactory();\n \t\t\tfactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n \t\t\tTransformer transformer = factory.newTransformer();\n \t\t\ttransformer.setOutputProperty(OutputKeys.INDENT, \"yes\"); //$NON-NLS-1$\n@@ -436,4 +436,18 @@ public String getTextData() {\n \t\t}\n \t\treturn \"\"; //$NON-NLS-1$\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n+\n+\tprivate static TransformerFactory createTransformerFactory() {\n+\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, \"\");\n+\t\treturn factory;\n+\t}\n }\n\\ No newline at end of file\n",
            "final": "diff --git a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\nindex 26e318d6..e8f3d908 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching.java/src/main/java/org/jboss/tools/rsp/internal/launching/java/util/LaunchingSupportUtils.java\n@@ -7,6 +7,7 @@\n  * Contributors: Red Hat, Inc.\n  ******************************************************************************/\n package org.jboss.tools.rsp.internal.launching.java.util;\n+import javax.xml.XMLConstants;\n \n import java.io.ByteArrayInputStream;\n import java.io.File;\n@@ -82,7 +83,7 @@\n \tprivate static DocumentBuilder getParser() throws CoreException {\n \t\tif (fgXMLParser == null) {\n \t\t\ttry {\n-\t\t\t\tfgXMLParser = DocumentBuilderFactory.newInstance().newDocumentBuilder();\n+\t\t\t\tfgXMLParser = createDocumentBuilderFactory().newDocumentBuilder();\n \t\t\t\tfgXMLParser.setErrorHandler(new DefaultHandler());\n \t\t\t} catch (ParserConfigurationException e) {\n \t\t\t\tabort(LaunchingPlugin_34, e);\n@@ -348,4 +349,11 @@ protected static void abort(String message, Throwable exception, int code) throw\n \t\tthrow new CoreException(new Status(IStatus.ERROR, IVMInstallChangedListener.LAUNCHING_ID_PLUGIN,\n \t\t\t\tcode, message, exception));\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n }\ndiff --git a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\nindex 291d3814..92e60d19 100644\n--- a/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n+++ b/framework/bundles/org.jboss.tools.rsp.launching/src/main/java/org/jboss/tools/rsp/launching/memento/XMLMemento.java\n@@ -89,7 +89,7 @@ public static XMLMemento createReadRoot(InputStream in) {\n \t\t\n \t\tDocument document = null;\n \t\ttry {\t\n-\t\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\t\tDocumentBuilderFactory factory = createDocumentBuilderFactory();\n \t\t\tDocumentBuilder parser = factory.newDocumentBuilder();\n \t\t\tdocument = parser.parse(new InputSource(in));\n \t\t\tNode node = document.getFirstChild();\n@@ -126,7 +126,7 @@ private static void logError(Exception t) {\n \tpublic static XMLMemento createWriteRoot(String type) {\n \t\tDocument document;\n \t\ttry {\n-\t\t\tdocument = DocumentBuilderFactory.newInstance().newDocumentBuilder().newDocument();\n+\t\t\tdocument = createDocumentBuilderFactory().newDocumentBuilder().newDocument();\n \t\t\tElement element = document.createElement(type);\n \t\t\tdocument.appendChild(element);\n \t\t\treturn new XMLMemento(document, element);\n@@ -348,7 +348,7 @@ public void save(OutputStream os) throws IOException {\n \t\tResult result = new StreamResult(os);\n \t\tSource source = new DOMSource(factory);\n \t\ttry {\n-\t\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\t\tTransformerFactory factory = createTransformerFactory();\n \t\t\tfactory.setFeature(XMLConstants.FEATURE_SECURE_PROCESSING, true);\n \t\t\tTransformer transformer = factory.newTransformer();\n \t\t\ttransformer.setOutputProperty(OutputKeys.INDENT, \"yes\"); //$NON-NLS-1$\n@@ -436,4 +436,18 @@ public String getTextData() {\n \t\t}\n \t\treturn \"\"; //$NON-NLS-1$\n \t}\n+\n+\tprivate static DocumentBuilderFactory createDocumentBuilderFactory() {\n+\t\tDocumentBuilderFactory factory = DocumentBuilderFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_SCHEMA, \"\");\n+\t\treturn factory;\n+\t}\n+\n+\tprivate static TransformerFactory createTransformerFactory() {\n+\t\tTransformerFactory factory = TransformerFactory.newInstance();\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_DTD, \"\");\n+\t\tfactory.setAttribute(XMLConstants.ACCESS_EXTERNAL_STYLESHEET, \"\");\n+\t\treturn factory;\n+\t}\n }\n\\ No newline at end of file\n"
        },
        "manualEdits": [
            {
                "type": "afterOpenPr",
                "reason": "this can be whatever",
                "diff": "I didn't actually do any manual edits :)\n"
            }
        ],
        "recordMetadata": {
            "createdAt": "2020-12-17 17:19:56.195013",
            "lastModified": "2020-12-17 17:29:41.391090"
        }
    }
}
```

### `sorald.warnings_extractor`
The warnings extractor script can be used to extract warnings from individual
commits in a given set of repositories. It's useful for finding projects that
are actively fixing Sonar warnings, as it provides a warning count delta
between each extracted commit.

Before using the script, build the Sorald jar by going to the root of the
repository and executing `mvn package -DskipTests`. Then, you can execute the
script like so.

```bash
$ python3 -m sorald.warnings_extractor path/to/repos_list.txt
```

This will execute the commit extractor with a bunch of default values for
different options. The most important assumption is that there
is a **Sorald jar in the target directory at the root of this repository**.
If there isn't, you must specify the path manually (or build the Sorald jar).
Execute the script with the `--help` for more detailed information on the rest
of the options.

`repos_list.txt` is a text file listing one repository per line, like so.

```
spoonlabs/sorald
inria/spoon
kth/spork
```

> **Note:** Currently, the commit extractor is optimized for projects using
> Maven. It will not find sources for any other build tools.

#### Limiting running time
If the experiment is taking too long, try limiting either a) the amount of
commits you extract (`--num-commits-per-repo`), or b) the step size between
commits (`--step-size`), or c) both of those.

#### Passing options to the miner
It's sometimes useful to pass options to the miner itself. This can be done
with the `--miner-option|--mo` argument. For example, to specify the
`--ruleTypes vulnerability` option for the miner, simply pass it as a miner
option.

```bash
$ python main.py path/to/repos_list.txt --miner-option 'ruleTypes=vulnerability'
```

Note the absence of leading `--` in front of `ruleTypes`, and the connecting
`=` between the name of the option, and its value.

### `sorald.issue_finder`
This is a small wrapper script around GitHub's [issue search
API](https://docs.github.com/en/free-pro-team@latest/rest/reference/search#search-issues-and-pull-requests).
Run like so.

```bash
$ python3 -m sorald.issue_finder --token <YOUR_GITHUB_TOKEN> --query <YOUR_QUERY>
```

There are a bunch of other options you can set as well, run with the `--help`
option for complete usage. Here's an example invocation searching for
the keyword "sonar".

```bash
$ python3 main.py --token xxxxxxxx --query sonar
https://github.com/pmd/pmd/issues/2942
https://github.com/SpoonLabs/sorald/issues/226
https://github.com/javaparser/javaparser/issues/2937
https://github.com/springdoc/springdoc-openapi-maven-plugin/issues/19
https://github.com/pmd/pmd/issues/2928
https://github.com/cnescatlab/sonar-cnes-report/issues/170
https://github.com/DPigeon/Money-Tree/issues/147
https://github.com/Riverside-Software/sonar-openedge/issues/856
https://github.com/pau101/Fairy-Lights/issues/94
https://github.com/Tencent/QMUI_Android/issues/1032
https://github.com/insideapp-oss/sonar-flutter/issues/9
https://github.com/SonarSource/sonar-css/issues/297
https://github.com/SonarSource/SonarJS/issues/1918
https://github.com/sonar-intellij-plugin/sonar-intellij-plugin/issues/83
https://github.com/find-sec-bugs/find-sec-bugs/issues/617
https://github.com/Nesreenmoh/sfg-pet-clinic/issues/82
https://github.com/Nesreenmoh/sfg-pet-clinic/issues/81
[...]
```

For more stuff you can do with the query string, see [the GitHub
docs](https://docs.github.com/en/free-pro-team@latest/github/searching-for-information-on-github/searching-issues-and-pull-requests).

> **Warning:** This script uses up API requests quite rapidly, and you'll hit
> the rate limit before you know it.
