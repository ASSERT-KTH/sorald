# Support workflows e.g. for generating documentation

name: support

on:
  push:
    branches: [ master ]

jobs:
  generate-achievements-handled_rules-md:
    if: ${{ github.repository == 'SpoonLabs/sorald' }} # don't accidentally run on forks :)
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@230611dbd0eb52da1e1f4f7bc8bb0c3a339fc8b7
        with:
          fetch-depth: 2
      - uses: actions/setup-python@8c5ea631b2b2d5d8840cf4a2b183a8a0edc1e40d # v2.2.0
        with:
          python-version: 3.8
      - name: Install support scripts
        run: |
          pip install --upgrade pip
          pip install -e experimentation/tools
      - name: Generate ACHIEVEMENTS.md and submit a PR if modified
        run: |
          SCRIPT_NAME=achievements
          GENERATED_FILE=docs/ACHIEVEMENTS.md
          python -m sorald.${SCRIPT_NAME} -p experimentation/prs.json -o ${GENERATED_FILE}

          ./.github/submit-pr.sh \
            --branch-prefix   ${SCRIPT_NAME} \
            --generated-file  ${GENERATED_FILE} \
            --gh-sha          ${{ github.sha }} \
            --gh-token        ${{ secrets.GITHUB_TOKEN }} \
            --gh-repository   ${{ github.repository }} \
            --gh-workflow     ${{ github.workflow }}
      - name: Generate HANDLED_RULES.md and submit a PR if modified
        run: |
          SCRIPT_NAME=handled_rules
          GENERATED_FILE=docs/HANDLED_RULES.md
          python -m sorald.${SCRIPT_NAME} -o ${GENERATED_FILE}

          ./.github/submit-pr.sh \
            --branch-prefix   ${SCRIPT_NAME} \
            --generated-file  ${GENERATED_FILE} \
            --gh-sha          ${{ github.sha }} \
            --gh-token        ${{ secrets.GITHUB_TOKEN }} \
            --gh-repository   ${{ github.repository }} \
            --gh-workflow     ${{ github.workflow }}
