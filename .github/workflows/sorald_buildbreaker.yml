# Workflow for breaking the build if Sorald finds a repairable violation.
#
# Note that actions are specified by commit hash. This is to avoid the security
# risk of someone injecting malicious code into a release and then simply
# changing a tag.

name: sorald-buildbreaker

on:
  pull_request:
  push:
    branches: master

jobs:
  check-for-repairable-violations:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@5a4ac9002d0be2fb38bd78e4b4dbde5606d7042f # v2.3.4
      - uses: actions/setup-java@8764a52df183aa0ccea74521dfd9d506ffc7a19a # v2.0.0
        with:
          java-version: 11
          distribution: 'adopt'
      - uses: actions/setup-python@8c5ea631b2b2d5d8840cf4a2b183a8a0edc1e40d # v2.2.0
        with:
          python-version: 3.8

      - name: Install support scripts
        run: |
          pip install --upgrade pip
          pip install -e experimentation/tools

      - name: Fetch Sorald snapshot
        run: curl $(python -m sorald.jarlink --sorald-version 0.1.0-SNAPSHOT) -o sorald.jar

      - name: Run Sorald buildbreaker
        run: python -m sorald.buildbreaker --source src/main/java --sorald-jar sorald.jar
